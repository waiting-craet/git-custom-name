{% extends "base.html" %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
    <div class="container">
        <div class="main-content">
            <article class="card">
                <h1 class="post-title">{{ post.title }}</h1>
                <div class="post-meta">
                    <span class="meta-item">作者：{{ post.author.username }}</span>
                    <span class="meta-item">时间：{{ post.created_at | datetimeformat('%Y-%m-%d %H:%M') }}</span>
                    <span class="meta-item">分类：<a href="{{ url_for('category_posts', category_id=post.category.id) }}">{{ post.category.name }}</a></span>
                    <span class="meta-item">阅读：{{ post.views }}</span>
                    <span class="meta-item">点赞：<span id="likes-count">{{ post.likes }}</span></span>
                </div>
                {% if post.tags %}
                <div class="post-tags">
                    {% for tag in post.tags %}
                    <a href="{{ url_for('tag_posts', tag_id=tag.id) }}" class="tag">#{{ tag.name }}</a>
                    {% endfor %}
                </div>
                {% endif %}
                <div class="post-content">
                    {{ post.content | safe }}
                </div>
                <div class="post-actions">
                    <button id="like-button" class="btn"
                        {% if not current_user %}
disabled title="请先登录"
                        {% endif %}
                    >
                        &hearts; 点赞
                    </button>
                    {% if current_user and current_user.id == post.author_id %}
                    <a href="{{ url_for('edit_post', post_id=post.id) }}" class="btn btn-outline">编辑</a>
                    <a href="{{ url_for('delete_post', post_id=post.id) }}" class="btn btn-outline" onclick="return confirm('确定要删除这篇文章吗？')">删除</a>
                    {% endif %}
                </div>
            </article>
            
            <!-- 文章导航 -->
            <div class="post-navigation">
                {% if prev_post %}
                <div class="prev-post">
                    <span class="nav-label">上一篇：</span>
                    <a href="{{ url_for('post_detail', post_id=prev_post.id) }}">{{ prev_post.title }}</a>
                </div>
                {% endif %}
                {% if next_post %}
                <div class="next-post">
                    <span class="nav-label">下一篇：</span>
                    <a href="{{ url_for('post_detail', post_id=next_post.id) }}">{{ next_post.title }}</a>
                </div>
                {% endif %}
                <a href="{{ url_for('index') }}" class="back-to-home">返回首页</a>
            </div>
            
            <!-- 评论区 -->
            <div class="comments-section">
                <h2 class="comments-title">评论 ({{ comments|length }})</h2>
                
                {% if current_user %}
                <div class="comment-form-container">
                    <h3 class="comment-form-title">发表评论</h3>
                    <form id="comment-form">
                        <input type="hidden" name="post_id" value="{{ post.id }}">
                        <div class="form-group">
                            <textarea class="form-control" name="content" rows="4" placeholder="请输入您的评论..." required></textarea>
                        </div>
                        <button type="submit" class="btn">发表评论</button>
                    </form>
                </div>
                {% else %}
                <p class="login-to-comment">请先<a href="{{ url_for('login') }}">登录</a>或<a href="{{ url_for('register') }}">注册</a>后发表评论</p>
                {% endif %}
                
                <div id="comments-list">
                    {% if comments %}
                        {% for comment in comments %}
                        <div class="comment-item">
                            <div class="comment-header">
                                <span class="comment-author">{{ comment.author.username }}</span>
                                <span class="comment-time">{{ comment.created_at | datetimeformat('%Y-%m-%d %H:%M') }}</span>
                            </div>
                            <div class="comment-content">{{ comment.content }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-comments">暂无评论，快来发表第一条评论吧！</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <aside class="sidebar">
            <!-- 文章作者信息 -->
            <div class="card">
                <div class="card-header">作者信息</div>
                <div class="author-info">
                    <div class="author-name">{{ post.author.username }}</div>
                    <div class="author-stats">
                        <span class="stat-item">文章：{{ post.author.posts|length }}</span>
                        <span class="stat-item">注册时间：{{ post.author.created_at | datetimeformat('%Y-%m-%d') }}</span>
                    </div>
                </div>
            </div>
            <!-- 相关文章可以在这里添加 -->
        </aside>
    </div>
    
    <style>
        .post-title {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #333;
            line-height: 1.3;
        }
        
        .post-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
            color: #666;
        }
        
        .post-meta a {
            color: #4CAF50;
            text-decoration: none;
        }
        
        .post-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .tag {
            display: inline-block;
            padding: 4px 12px;
            background-color: #f0f0f0;
            color: #666;
            border-radius: 20px;
            font-size: 0.85rem;
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .tag:hover {
            background-color: #4CAF50;
            color: white;
            transform: translateY(-1px);
        }
        
        .post-content {
            margin-bottom: 40px;
            line-height: 1.8;
            color: #333;
        }
        
        .post-content p {
            margin-bottom: 15px;
        }
        
        .post-content pre {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 15px;
        }
        
        .post-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        .post-navigation {
            margin: 40px 0;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .prev-post, .next-post {
            margin-bottom: 10px;
        }
        
        .nav-label {
            font-weight: 500;
            color: #666;
        }
        
        .post-navigation a {
            color: #4CAF50;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .post-navigation a:hover {
            color: #333;
            text-decoration: underline;
        }
        
        .back-to-home {
            display: inline-block;
            margin-top: 10px;
            color: #666;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .back-to-home:hover {
            color: #4CAF50;
        }
        
        .comments-section {
            margin-top: 50px;
        }
        
        .comments-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #333;
        }
        
        .comment-form-container {
            margin-bottom: 30px;
        }
        
        .comment-form-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #555;
        }
        
        .login-to-comment {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-to-comment a {
            color: #4CAF50;
            text-decoration: none;
        }
        
        .login-to-comment a:hover {
            text-decoration: underline;
        }
        
        .comment-item {
            background-color: #f9f9f9;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .comment-author {
            font-weight: 500;
            color: #333;
        }
        
        .comment-time {
            color: #999;
        }
        
        .comment-content {
            line-height: 1.6;
            color: #555;
        }
        
        .no-comments {
            text-align: center;
            padding: 40px 0;
            color: #999;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .author-info {
            text-align: center;
        }
        
        .author-name {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 10px;
            color: #333;
        }
        
        .author-stats {
            display: flex;
            flex-direction: column;
            gap: 5px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .stat-item {
            padding: 5px 0;
        }
    </style>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 点赞功能
            const likeButton = document.getElementById('like-button');
            const likesCount = document.getElementById('likes-count');
            
            likeButton.addEventListener('click', function() {
                if (this.disabled) return;
                
                fetch('{{ url_for('like_post', post_id=post.id) }}')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            likesCount.textContent = data.likes;
                            likeButton.disabled = true;
                            likeButton.style.backgroundColor = '#dc3545';
                            likeButton.textContent = '已点赞';
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('点赞失败:', error);
                    });
            });
            
            // 评论功能
            const commentForm = document.getElementById('comment-form');
            if (commentForm) {
                commentForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const submitBtn = this.querySelector('[type="submit"]');
                    submitBtn.classList.add('loading');
                    submitBtn.disabled = true;
                    
                    const formData = new FormData(this);
                    
                    fetch('{{ url_for('add_comment', post_id=post.id) }}', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        submitBtn.classList.remove('loading');
                        submitBtn.disabled = false;
                        
                        if (data.status === 'success') {
                            // 清空表单
                            commentForm.reset();
                            
                            // 添加新评论到列表
                            const commentsList = document.getElementById('comments-list');
                            const noComments = commentsList.querySelector('.no-comments');
                            if (noComments) {
                                commentsList.removeChild(noComments);
                            }
                            
                            const commentDiv = document.createElement('div');
                            commentDiv.className = 'comment-item';
                            commentDiv.innerHTML = `
                                <div class="comment-header">
                                    <span class="comment-author">${data.comment.author}</span>
                                    <span class="comment-time">${data.comment.created_at}</span>
                                </div>
                                <div class="comment-content">${data.comment.content}</div>
                            `;
                            
                            // 添加到列表开头
                            commentsList.insertBefore(commentDiv, commentsList.firstChild);
                            
                            // 更新评论数
                            const commentsTitle = document.querySelector('.comments-title');
                            const currentCount = parseInt(commentsTitle.textContent.match(/\d+/)[0]);
                            commentsTitle.textContent = `评论 (${currentCount + 1})`;
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch(error => {
                        console.error('评论失败:', error);
                        submitBtn.classList.remove('loading');
                        submitBtn.disabled = false;
                    });
                });
            }
        });
    </script>
{% endblock %}